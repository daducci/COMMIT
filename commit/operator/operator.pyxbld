import numpy
from os import utime
from os.path import dirname, join
from setuptools import Extension
import sys

# pass parameters to the compiler at runtime
# [TODO] find a way to avoid using this fake module
from commit.operator import config


def make_ext(modname, pyxfilename):
    if (config.nIC is None or config.nIC < 0 or config.nIC > 20):
        raise RuntimeError('config.nIC must be in the range [0..20]')
    if (config.nEC is None or config.nEC < 0 or config.nEC > 20):
        raise RuntimeError('config.nEC must be in the range [0..20]')
    if (config.nISO is None or config.nISO < 0 or config.nISO > 20):
        raise RuntimeError('config.nISO must be in the range [0..20]')

    # Force recompilation
    if config.model == "VolumeFractions":
        filename = "operator_noLUT.c"
    else:
        filename = "operator_withLUT.c"
    path = dirname(pyxfilename)

    if config.build_dir is None:
        utime( join(path,filename), None)

    include_dirs = [numpy.get_include()]
    libraries = []
    library_dirs = []
    extra_compile_args = []
    if sys.platform.startswith('win32'):
        include_dirs.append('C:/Users/clori/Desktop/COMMIT_example_dataset/pthreads-w32-2-9-1-release/include')
        libraries.append('pthreadVC2')
        library_dirs.append('C:/Users/clori/Desktop/COMMIT_example_dataset/pthreads-w32-2-9-1-release/lib/x64')
        extra_compile_args.extend(['/std:c++14', '/fp:fast', '/DHAVE_STRUCT_TIMESPEC'])
    if sys.platform.startswith('darwin') or sys.platform.startswith('linux'):
        extra_compile_args.extend(['-w', '-O3', '-Ofast'])

    return Extension(name=modname,
                    sources=[pyxfilename, join(path, filename)],
                    include_dirs=include_dirs,
                    libraries=libraries,
                    library_dirs=library_dirs,
                    define_macros=[('nIC', config.nIC),
                                    ('nEC', config.nEC),
                                    ('nISO', config.nISO)],
                    extra_compile_args=extra_compile_args)
